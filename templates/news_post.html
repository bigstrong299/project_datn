{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <form action="{{ url_for('admin_news.edit_post', post_id=post.id) if post else url_for('admin_news.create_post') }}" 
                  method="POST" enctype="multipart/form-data" id="postForm">
                
                <div class="container py-4">
                    <div class="row g-4">
               <div class="card content-card p-4 p-lg-5">

    <div class="card-header-custom mb-4">
        <div class="header-wrapper">
            <div class="header-left">
                <a href="{{ url_for('admin_news.manage') }}" class="btn-back">
                    <i class="fa fa-arrow-left"></i>
                </a>
                <div>
                    <h4 class="mb-1 fw-bold">{{ 'Chỉnh sửa bài viết' if post else 'Tạo bài viết mới' }}</h4>
                    <small class="text-muted">Soạn thảo và xuất bản bài viết</small>
                </div>
            </div>
            <div class="header-right">
                <button type="button" class="btn btn-outline-secondary btn-action" id="btnPreview">
                    <i class="fa fa-mobile-alt me-2"></i>
                    <span class="btn-text ms-1">Xem trước App</span>
                </button>
                <button type="submit" class="btn btn-primary btn-action">
                    <i class="fa fa-paper-plane"></i>
                    <span class="btn-text ms-1">{{ 'Cập nhật' if post else 'Xuất bản' }}</span>
                </button>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 pe-lg-5">
            <div class="mb-5">
                <label class="form-label fw-semibold text-muted mb-2">
                    <i class="fa fa-heading me-2"></i>Tiêu đề bài viết <span class="text-danger">*</span>
                </label>
                <input type="text" name="title" id="inputTitle" class="form-control form-control-title" 
                       placeholder="Nhập tiêu đề hấp dẫn..." 
                       value="{{ post.title if post else '' }}" required>
            </div>

            <div class="mb-5">
                <label class="form-label fw-semibold text-muted mb-2"><i class="fa fa-align-left me-2"></i>Mô tả ngắn</label>
                <textarea name="description" id="inputDesc" class="form-control form-control-desc" rows="3"
                    placeholder="Mô tả ngắn gọn..." maxlength="200">{{ post.description if post else '' }}</textarea>
            </div>

            <div class="mb-5">
                <label class="form-label fw-semibold text-muted mb-3"><i class="fa fa-image me-2"></i>Ảnh đại diện</label>

                <div class="upload-zone" onclick="document.getElementById('imageInput').click()" id="uploadZone">
                    <div class="upload-content {{ 'd-none' if post and post.image else '' }}" id="uploadContent">
                        <div class="upload-icon"><i class="fa fa-cloud-upload-alt fa-3x"></i></div>
                        <div class="upload-text"><p class="mb-1 fw-semibold">Chọn ảnh từ máy</p></div>
                    </div>

                    <div class="upload-preview {{ '' if post and post.image else 'd-none' }}" id="uploadPreview">
                        <img id="imagePreview" src="{{ post.image if post and post.image else '#' }}" alt="Preview">
                        <div class="upload-overlay">
                            <button type="button" class="btn btn-light btn-sm" onclick="event.stopPropagation(); removeImage()">
                                <i class="fa fa-trash me-1"></i>Xóa
                            </button>
                        </div>
                    </div>
                </div>
                
                <input type="file" name="image" id="imageInput" class="d-none" accept="image/*" onchange="previewImage(this)">
            </div>

            <div class="mb-4">
                <label class="form-label fw-semibold text-muted mb-3"><i class="fa fa-file-alt me-2"></i>Nội dung bài viết <span class="text-danger">*</span></label>
                <div class="editor-wrapper">
                    <textarea name="content" id="editor">{{ post.content if post else '' }}</textarea>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="sidebar-card p-4">
                <div class="mb-4">
                    <label class="form-label-sidebar">Danh mục <span class="text-danger">*</span></label>
                    <select name="category_id" id="inputCategory" class="form-select form-select-custom" required>
                        <option value="" disabled {{ 'selected' if not post else '' }}>Chọn danh mục</option>
                        {% for cat in categories %}
                        <option value="{{ cat.id }}" 
                                {{ 'selected' if post and post.category_id == cat.id else '' }}>
                            {{ cat.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-4">
                    <label class="form-label-sidebar">Trạng thái</label>
                    <select name="status" class="form-select form-select-custom">
                        <option value="published" {{ 'selected' if post and post.status == 'published' else '' }}>Xuất bản ngay</option>
                        <option value="draft" {{ 'selected' if post and post.status == 'draft' else '' }}>Bản nháp</option>
                    </select>
                </div>
                <div class="mb-0">
                    <label class="form-label-sidebar">Tags</label>
                    <input type="text" name="tags" class="form-control form-control-custom" 
                           value="{{ post.tags if post and post.tags else '' }}">
                </div>
            </div>
        </div>
    </div>
</div>
            </div>
        </div>
        </form>
    </div>
</div>

<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content mobile-frame">
            <div class="phone-status-bar"><span>09:41</span></div>
            <div class="app-header"><span class="app-header-title">Chi tiết tin tức</span></div>
            <div class="modal-body p-0 bg-white">
                <div class="app-scroll-content">
                    <div class="app-cover-img" id="previewCoverImg"></div>
                    <div class="app-body">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-success bg-opacity-10 text-success rounded-pill px-2 me-2" id="previewCategory">Tin tức</span>
                            <small class="text-muted" id="previewDate">Hôm nay</small>
                        </div>
                        <h5 class="app-title" id="previewTitleDisplay">Tiêu đề</h5>
                        <div class="app-sapo" id="previewDescDisplay">Mô tả...</div>
                        <hr class="my-3 opacity-25">
                        <div class="app-content-html" id="previewBody"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-center pt-2 pb-3 border-0 bg-white">
                <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.ckeditor.com/ckeditor5/40.0.0/classic/ckeditor.js"></script>
<script>
    let myEditor;
    // ... Adapter Upload Ảnh giữ nguyên ...
    class MyUploadAdapter {
        constructor(loader) { this.loader = loader; }
        upload() {
            return this.loader.file.then(file => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) { resolve({ default: e.target.result }); };
                reader.onerror = function(error) { reject(error); };
                reader.readAsDataURL(file);
            }));
        }
        abort() {}
    }
    function MyCustomUploadAdapterPlugin(editor) {
        editor.plugins.get('FileRepository').createUploadAdapter = (loader) => { return new MyUploadAdapter(loader); };
    }

    ClassicEditor.create(document.querySelector('#editor'), {
        extraPlugins: [MyCustomUploadAdapterPlugin],
        toolbar: ['heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList', '|', 'uploadImage', 'blockQuote', 'undo', 'redo']
    }).then(editor => { myEditor = editor; }).catch(error => { console.error(error); });

    // JS Preview Ảnh
    function previewImage(input) {
        const uploadContent = document.getElementById('uploadContent');
        const uploadPreview = document.getElementById('uploadPreview');
        const imagePreview = document.getElementById('imagePreview');

        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                uploadContent.classList.add('d-none');
                uploadPreview.classList.remove('d-none');
            }
            reader.readAsDataURL(file);
        }
    }
    
    function removeImage() {
        document.getElementById('imageInput').value = '';
        document.getElementById('uploadPreview').classList.add('d-none');
        document.getElementById('uploadContent').classList.remove('d-none');
        document.getElementById('imagePreview').src = '#';
    }

    // JS Preview App (Cập nhật lấy dữ liệu từ các trường có value sẵn)
    document.getElementById('btnPreview').addEventListener('click', function() {
        const title = document.getElementById('inputTitle').value || 'Chưa có tiêu đề';
        // Lấy value từ textarea (đối với description)
        const desc = document.getElementById('inputDesc').value || 'Chưa có mô tả';
        const content = myEditor ? myEditor.getData() : '';
        const catSelect = document.getElementById('inputCategory');
        const category = catSelect.options[catSelect.selectedIndex].text;
        
        document.getElementById('previewTitleDisplay').textContent = title;
        document.getElementById('previewDescDisplay').textContent = desc;
        document.getElementById('previewBody').innerHTML = content;
        if(category) document.getElementById('previewCategory').textContent = category;

        const currentSrc = document.getElementById('imagePreview').getAttribute('src');
        const coverDiv = document.getElementById('previewCoverImg');
        if (currentSrc && currentSrc !== '#' && currentSrc !== '') {
            coverDiv.style.backgroundImage = `url('${currentSrc}')`;
            coverDiv.style.display = 'block';
        } else {
            coverDiv.style.display = 'none';
        }
        
        new bootstrap.Modal(document.getElementById('previewModal')).show();
    });

    const uploadZone = document.getElementById('uploadZone');
    uploadZone.addEventListener('click', () => document.getElementById('imageInput').click());
</script>

<style>
    /* CSS CŨ ĐÃ ĐƯỢC PHỤC HỒI (BAO GỒM FIX NỀN TRẮNG) */
    :root {
        --primary-color: #0b4a3b;
        --primary-light: #0f5c49;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --info-color: #3b82f6;
        --border-color: #e2e8f0;
        --bg-light: #f8fafc;
        --text-muted: #64748b;
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        overflow-x: hidden;
    }

    .container-fluid {
        max-width: 100%;
        padding-left: 0;
        padding-right: 0;
    }

    /* Content Card */
    .content-card {
        background: white;
        border-radius: 16px;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
        overflow: hidden;
    }

    .card-header-custom {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-bottom: 1px solid var(--border-color);
        padding: 1.25rem 1.5rem;
    }

    .header-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex: 1;
        min-width: 250px;
    }

    .header-right {
        display: flex;
        gap: 0.75rem;
        flex-shrink: 0;
    }

    .btn-back {
        width: 40px; height: 40px; border-radius: 50%;
        background: #f3f4f6; display: flex; align-items: center; justify-content: center;
        color: #666; transition: 0.2s; text-decoration: none;
    }
    .btn-back:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        transform: translateX(-3px);
    }

    .btn-action {
        border-radius: 10px;
        padding: 0.5rem 1rem;
        font-weight: 500;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        white-space: nowrap;
        font-size: 0.875rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
        border: none;
        box-shadow: 0 4px 10px rgba(11, 74, 59, 0.2);
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(11, 74, 59, 0.3);
    }
    .btn-outline-secondary {
        border: 2px solid var(--border-color);
        background: white;
        color: var(--text-muted);
    }
    .btn-outline-secondary:hover {
        background: var(--bg-light);
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    /* --- INPUT STYLE FIX (NỀN TRẮNG CHỮ ĐEN) --- */
    .form-control,
    .form-select,
    .form-control-title,
    .form-control-desc,
    .form-control-custom,
    .form-select-custom,
    input[type="text"],
    textarea {
        background-color: #ffffff !important;
        color: #1e293b !important;
        border: 1px solid #ced4da;
    }
    .form-control:focus, .form-select:focus {
        background-color: #ffffff !important;
        color: #1e293b !important;
        box-shadow: 0 0 0 0.25rem rgba(11, 74, 59, 0.15);
    }

    .form-control-title {
        font-size: 1rem;
        font-weight: 700;
        border: 1px solid #e2e8f0 !important;
        border-radius: 8px !important;
        padding: 1rem 0.5rem !important;
        transition: all 0.3s;
        background: white;
    }

    /* Upload Zone */
    .upload-zone {
        border: 3px dashed var(--border-color);
        border-radius: 16px;
        background: #ffffff; /* Nền trắng */
        min-height: 280px;
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .upload-zone:hover, .upload-zone.drag-over {
        border-color: var(--primary-color);
        background: #f0fdfa;
        transform: scale(1.01);
    }

    .upload-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .upload-icon {
        width: 80px; height: 80px; border-radius: 50%;
        background: linear-gradient(135deg, #e0e7ff 0%, #dbeafe 100%);
        display: flex; align-items: center; justify-content: center;
        color: var(--primary-color); margin-bottom: 1.5rem; transition: all 0.3s;
    }

    .upload-zone:hover .upload-icon {
        transform: scale(1.1);
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
        color: white;
    }

    /* FIX LỖI PREVIEW */
    .upload-preview {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        z-index: 10;
        background: white;
    }

    .upload-preview img {
        width: 100%; height: 100%; object-fit: cover; display: block;
    }

    .upload-overlay {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex; align-items: center; justify-content: center;
        opacity: 0; transition: all 0.3s;
    }
    .upload-preview:hover .upload-overlay { opacity: 1; }

    .d-none { display: none !important; }

    /* Editor */
    .editor-wrapper { border: 2px solid var(--border-color); border-radius: 12px; overflow: hidden; }
    .ck-editor__editable { min-height: 400px; padding: 1.5rem; background: #ffffff !important; }

    /* Sidebar */
    .sidebar-card { background: white; border-radius: 16px; box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); }
    .form-label-sidebar { font-size: 0.8125rem; font-weight: 600; color: #475569; margin-bottom: 0.5rem; display: flex; align-items: center; }

    /* Mobile Preview */
    @media (min-width: 576px) { .modal-dialog { max-width: 375px; margin: 1.75rem auto; } }
    .mobile-frame { border-radius: 30px; border: 8px solid #1e293b; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.2); background: #ffffff; }
    .phone-status-bar { background: #fff; padding: 10px 20px 5px; display: flex; justify-content: space-between; font-size: 12px; font-weight: 600; color: #000; }
    .app-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #fff; border-bottom: 1px solid #f1f1f1; }
    .app-cover-img { width: 100%; height: 200px; background-size: cover; background-position: center; display: none; }
    .app-body { padding: 15px; }
    .app-title { font-weight: 800; font-size: 20px; line-height: 1.3; margin-bottom: 10px; color: #111; }
    .app-content-html { font-size: 15px; line-height: 1.6; color: #333; }
    .app-content-html img { max-width: 100% !important; height: auto !important; border-radius: 8px; margin: 10px 0; }
    .modal-dialog-scrollable .modal-content { max-height: 85vh; }
</style>
{% endblock %}